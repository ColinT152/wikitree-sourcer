(function () {
  var CLICK_ID_PARAM_NAME = 'ld_trk';
  var i;

  var querystring = {};
  var search = window.location.search.slice(1);
  var params = search.split('&');
  for (i = 0; i < params.length; ++i) {
    var param = params[i];
    var param_parts = param.split('=');
    querystring[param_parts[0]] = param_parts[1];
  }

  var lockerdome_click_id = querystring[CLICK_ID_PARAM_NAME];
  if (lockerdome_click_id) {
    var domain = '.' + window.location.hostname;
    var expiry_date = new Date(Date.now() + 86400000 * 30);

    document.cookie = 'lockerdome_click_id='+lockerdome_click_id+';path=/;domain='+domain+';expires='+expiry_date.toUTCString();

    var is_landing_page = /go\.newspapers\.com/.test(window.location.href);
    if (is_landing_page) {
      var search_form = document.getElementById('search');
      if (search_form) {
        var ld_trk_input = document.createElement('input');
        ld_trk_input.setAttribute('name', 'ld_trk');
        ld_trk_input.setAttribute('type', 'hidden');
        ld_trk_input.setAttribute('value', lockerdome_click_id);
        search_form.appendChild(ld_trk_input);
      }

      var anchor_tags = document.querySelectorAll('a');
      for(i = 0; i < anchor_tags.length; ++i) {
        var anchor_tag = anchor_tags[i];
        var ld_trk_string = "ld_trk=" + lockerdome_click_id;
        if (/\?/.test(anchor_tag.href)) {
          ld_trk_string = "&" + ld_trk_string;
        } else {
          ld_trk_string = "?" + ld_trk_string;
        }
        anchor_tag.href += ld_trk_string;
      }
    }
  } else {
    // TODO: Consider clearing cookie when view-through
  }
  
  if (window.location.pathname === "/account/billing/") {
    var script = document.createElement('script');
    script.src = "https://cdn1.decide.dev/tracking/ancestry_newspapers_lead.js";
    document.body.appendChild(script);
  }
})();
